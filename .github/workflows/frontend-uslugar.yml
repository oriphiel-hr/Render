name: Frontend - Build & Deploy (Hostinger)

on:
  workflow_dispatch:
  push:
    branches: ["main"]
    paths:
      - "Uslugar/frontend/**"
      - ".github/workflows/frontend-uslugar.yml"

permissions:
  id-token: write
  contents: read

env:
  FRONTEND_DIR: Uslugar/frontend
  BUILD_CMD: npm ci && npm run build
  DIST_DIR: Uslugar/frontend/dist
  # SERVER_DIR removed - determined dynamically in 'Determine SERVER_DIR' step

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Ensure package-lock.json (if Node project)
        run: |
          set -e
          if [ -f "${{ env.FRONTEND_DIR }}/package.json" ]; then
            cd "${{ env.FRONTEND_DIR }}"
            test -f package-lock.json || npm i --package-lock-only
          else
            echo "No package.json -> static site"
          fi

      - name: Setup Node (if Node project)
        if: ${{ hashFiles(format('{0}/package.json', env.FRONTEND_DIR)) != '' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm
          cache-dependency-path: ${{ env.FRONTEND_DIR }}/package-lock.json

      - name: Detect framework (static aware)
        id: fw
        working-directory: ${{ env.FRONTEND_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          FW=$(node -e '
            let p=null; try { p=require("./package.json"); } catch(e) {}
            if(!p){ process.stdout.write("static"); process.exit(0); }
            const d={...(p.dependencies||{}), ...(p.devDependencies||{})};
            if (d.next) process.stdout.write("next");
            else if (d.vite) process.stdout.write("vite");
            else if (d["react-scripts"]) process.stdout.write("cra");
            else if (d["@angular/cli"]) process.stdout.write("angular");
            else process.stdout.write("unknown");
          ')
          echo "framework=$FW" >> "$GITHUB_OUTPUT"
          echo "Detected: $FW"

      - name: Build (skip for static)
        if: ${{ steps.fw.outputs.framework != 'static' }}
        working-directory: ${{ env.FRONTEND_DIR }}
        env:
          VITE_API_URL: ${{ secrets.VITE_API_URL || 'https://api.uslugar.eu' }}
        shell: bash
        run: |
          set -euo pipefail
          case "${{ steps.fw.outputs.framework }}" in
            next)
              if npm run -s | grep -qE '^ *export *'; then
                npm ci && npm run build && npm run export
              else
                npm ci && npm run build && npx --yes next export || true
              fi
              ;;
            cra)
              npm ci && npm run build
              ;;
            angular|vite|unknown)
              eval "${BUILD_CMD}"
              ;;
          esac

      - name: List artifacts (debug)
        working-directory: ${{ env.FRONTEND_DIR }}
        run: |
          echo "== top =="; ls -la
          echo "== dist =="; ls -la dist || true
          echo "== build =="; ls -la build || true
          echo "== out =="; ls -la out || true
          echo "== .next =="; ls -la .next || true

      - name: Detect output dir
        id: detect
        working-directory: ${{ env.FRONTEND_DIR }}
        shell: bash
        run: |
          set -euo pipefail
          fw="${{ steps.fw.outputs.framework }}"
          candidates=()
          if [ "$fw" = "next" ]; then candidates+=("out" ".next"); fi
          candidates+=("${DIST_DIR}" "dist" "build" "out" "public" ".")
          echo "Candidates: ${candidates[*]}"
          found=""
          for d in "${candidates[@]}"; do
            if [ -d "$d" ]; then
              if [ -f "$d/index.html" ]; then found="$d"; break; fi
              if [ "$d" != ".next" ] && [ "$(find "$d" -type f | wc -l)" -gt 0 ]; then found="$d"; break; fi
            fi
          done
          if [ -z "$found" ] && [ -d ".next" ]; then
            echo "SSR build (.next) se ne mo≈æe deployati preko FTP-a bez servera."; exit 1
          fi
          if [ -z "$found" ]; then
            echo "Nije naƒëen build output (index.html)."; exit 1
          fi
          echo "dir=$found" >> "$GITHUB_OUTPUT"
          echo "Using: $found"

      - name: Validate FTP Secrets
        run: |
          echo "üîç Validating FTP configuration..."
          if [ -n "${{ secrets.HOSTINGER_HOST }}" ]; then
            FTP_HOST="${{ secrets.HOSTINGER_HOST }}"
            FTP_USER="${{ secrets.HOSTINGER_USERNAME }}"
            FTP_PASS="${{ secrets.HOSTINGER_PASSWORD }}"
            echo "‚úÖ Using HOSTINGER_* secrets"
          elif [ -n "${{ secrets.FTP_HOST }}" ]; then
            FTP_HOST="${{ secrets.FTP_HOST }}"
            FTP_USER="${{ secrets.FTP_USERNAME }}"
            FTP_PASS="${{ secrets.FTP_PASSWORD }}"
            echo "‚úÖ Using FTP_* secrets (fallback)"
          else
            echo "‚ùå ERROR: No FTP secrets found!"; exit 1
          fi
          CLEANED_HOST="${FTP_HOST#ftp://}"; CLEANED_HOST="${CLEANED_HOST#ftps://}"; CLEANED_HOST="${CLEANED_HOST#sftp://}"
          CLEANED_HOST="${CLEANED_HOST%/}"; CLEANED_HOST="${CLEANED_HOST%:*}"
          echo "FTP_HOST=$CLEANED_HOST" >> $GITHUB_ENV
          echo "FTP_USER=$FTP_USER" >> $GITHUB_ENV
          echo "FTP_PASS=$FTP_PASS" >> $GITHUB_ENV
          echo "FTP_HOST_FOR_DEBUG=$CLEANED_HOST" >> $GITHUB_ENV

      - name: Determine SERVER_DIR based on structure
        id: determine-dir
        run: |
          # Use secret if set, otherwise use default (auto-detection removed to prevent duplication)
          if [ -n "${{ secrets.HOSTINGER_SERVER_DIR }}" ]; then
            DETERMINED_DIR="${{ secrets.HOSTINGER_SERVER_DIR }}"
            echo "‚úÖ Using HOSTINGER_SERVER_DIR secret: [$DETERMINED_DIR]"
          else
            # Default: public_html/ (assumes FTP root is at /files/, not /files/public_html/)
            # If you get public_html/public_html/, your FTP root is already in public_html/
            # In that case, set HOSTINGER_SERVER_DIR secret to "/"
            DETERMINED_DIR="public_html/"
            echo "‚ö†Ô∏è  Using default: [$DETERMINED_DIR]"
            echo "‚ÑπÔ∏è  If files go to /files/public_html/public_html/, set HOSTINGER_SERVER_DIR secret to '/'"
            echo "‚ÑπÔ∏è  If files go to /files/, set HOSTINGER_SERVER_DIR secret to 'public_html/'"
          fi
          # Handle special case: if public_html/ causes duplication, try without trailing slash or use "."
          # Ensure trailing slash (except for "/")
          if [ "$DETERMINED_DIR" != "/" ] && [[ "$DETERMINED_DIR" != */ ]]; then
            DETERMINED_DIR="${DETERMINED_DIR}/"
            echo "üìù Added trailing slash: [$DETERMINED_DIR]"
          fi
          # Special handling: if public_html/ causes public_html/public_html/, try "." (current directory navigation)
          if [ "$DETERMINED_DIR" = "public_html/" ]; then
            # Check if this might cause duplication - if so, we need different approach
            echo "‚ö†Ô∏è  Using public_html/ - if you see duplication, try setting secret to '.' or '/'"
          fi
          echo "SERVER_DIR=$DETERMINED_DIR" >> $GITHUB_ENV
          echo "determined_dir=$DETERMINED_DIR" >> $GITHUB_OUTPUT
          echo "‚úÖ Final SERVER_DIR that will be used: [$DETERMINED_DIR]"

      - name: Test FTP connection
        continue-on-error: true
        run: |
          echo "üîç Testing FTP connection..."
          for port in 21 22 990; do
            if timeout 10 bash -c "echo > /dev/tcp/${{ env.FTP_HOST }}/$port" 2>/dev/null; then
              echo "‚úÖ Port $port reachable"
            else
              echo "‚ö†Ô∏è  Port $port not reachable"
            fi
          done

      - name: Deploy via FTP
        id: deploy-ftp
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.6
        with:
          server: ${{ env.FTP_HOST }}
          username: ${{ env.FTP_USER }}
          password: ${{ env.FTP_PASS }}
          protocol: 'ftp'
          port: 21
          local-dir: ${{ env.FRONTEND_DIR }}/${{ steps.detect.outputs.dir }}/
          server-dir: ${{ steps.determine-dir.outputs.determined_dir }}
          dangerous-clean-slate: false
          timeout: 600000
          log-level: verbose
          state-name: .ftp-deploy-sync-state.json
          dry-run: false
          exclude: |
            **/.git*
            **/.git*/**
            **/node_modules/**
            **/.DS_Store
