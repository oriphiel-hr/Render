generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums (must be defined before models that use them)
enum SupportPriority {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum SupportStatus {
  OPEN
  IN_PROGRESS
  RESOLVED
  CLOSED
}

enum SupportCategory {
  BILLING
  TECHNICAL
  REFUND
  FEATURE_REQUEST
  OTHER
}

enum ModerationStatus {
  PENDING // Čeka moderaciju
  APPROVED // Odobreno
  REJECTED // Odbijeno
}

enum ReportStatus {
  PENDING // Čeka pregled
  REVIEWED // Pregledano
  DISMISSED // Odbijeno (prijava nije opravdana)
  ACCEPTED // Prihvaćeno (recenzija je lažna)
}

enum AuditActionType {
  MESSAGE_CREATED // Poruka kreirana
  MESSAGE_EDITED // Poruka uređena
  MESSAGE_DELETED // Poruka obrisana
  ATTACHMENT_UPLOADED // Privitak uploadan
  ATTACHMENT_DELETED // Privitak obrisan
  CONTACT_REVEALED // Kontakt otkriven
  CONTACT_MASKED // Kontakt maskiran
  ROOM_CREATED // Chat room kreiran
  ROOM_DELETED // Chat room obrisan
}

enum SLASStatus {
  PENDING // Čeka odgovor
  MET // SLA ispunjen (odgovoreno unutar vremena)
  BREACHED // SLA prekoračen (nije odgovoreno unutar vremena)
}

// Support Ticket System (must be before User model)
model SupportTicket {
  id         String          @id @default(cuid())
  userId     String
  subject    String
  message    String
  priority   SupportPriority @default(NORMAL)
  status     SupportStatus   @default(OPEN)
  category   SupportCategory @default(OTHER)
  assignedTo String?
  notes      String?
  resolvedAt DateTime?
  createdAt  DateTime        @default(now())
  updatedAt  DateTime        @updatedAt

  user User @relation("UserSupportTickets", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@index([priority])
  @@index([category])
}

// White-Label Configuration - PRO users only
model WhiteLabel {
  id              String   @id @default(cuid())
  userId          String   @unique
  companyName     String // Naziv firme/kampanje
  logoUrl         String? // URL do custom loga
  primaryColor    String   @default("#3B82F6") // Glavna boja (hex)
  secondaryColor  String? // Sekundarna boja
  accentColor     String? // Akcentna boja
  faviconUrl      String? // Custom favicon
  footerText      String? // Custom footer tekst
  poweredByHidden Boolean  @default(false) // Sakriti "Powered by Uslugar"
  customDomain    String? // Custom domain (budući feature)
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user User @relation("UserWhiteLabel", fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model User {
  id                        String       @id @default(cuid())
  email                     String // Unique per role, not globally
  passwordHash              String
  fullName                  String
  role                      Role         @default(USER)
  phone                     String?
  phoneVerified             Boolean      @default(false) // SMS verifikacija telefona
  phoneVerificationCode     String?      @unique // 6-digit SMS kod
  phoneVerificationExpires  DateTime? // Istek SMS verifikacijskog koda (10 min)
  phoneVerificationAttempts Int          @default(0) // Broj pokušaja verifikacije (max 5)
  phoneVerifiedAt           DateTime? // Kada je telefon verificiran
  city                      String?
  latitude                  Float? // Geolokacija
  longitude                 Float? // Geolokacija
  isVerified                Boolean      @default(false) // Verifikacija korisnika
  verificationToken         String?      @unique // Token za email verifikaciju
  tokenExpiresAt            DateTime? // Istek verifikacijskog tokena
  resetPasswordToken        String?      @unique // Token za resetiranje lozinke
  resetPasswordExpires      DateTime? // Istek reset tokena (1h)
  legalStatus               LegalStatus? @relation("UserLegalStatus", fields: [legalStatusId], references: [id])
  legalStatusId             String? // Pravni status (za firme koje traže usluge)
  taxId                     String? // OIB
  companyName               String? // Naziv firme
  createdAt                 DateTime     @default(now())
  updatedAt                 DateTime     @updatedAt

  providerProfile     ProviderProfile?
  jobs                Job[]                     @relation("UserJobs")
  assignedJobs        Job[]                     @relation("AssignedJobs")
  offers              Offer[]
  reviewsGiven        Review[]                  @relation("reviewsGiven")
  reviewsReceived     Review[]                  @relation("reviewsReceived")
  notifications       Notification[]
  chatMessages        ChatMessage[]             @relation("senderMessages")
  chatRooms           ChatRoom[]                @relation("participants")
  messageVersions     MessageVersion[]          @relation("messageVersions")
  leadPurchases       LeadPurchase[]
  chatbotSessions     ChatbotSession[]          @relation("ChatbotSessions")
  providerROI         ProviderROI?
  creditTransactions  CreditTransaction[]
  clientVerification  ClientVerification?
  subscriptions       Subscription[]
  subscriptionHistory SubscriptionHistory[]     @relation("UserSubscriptionHistory")
  trialEngagement     TrialEngagement?
  invoices            Invoice[]
  supportTickets      SupportTicket[]           @relation("UserSupportTickets")
  whiteLabel          WhiteLabel?               @relation("UserWhiteLabel")
  smsLogs             SmsLog[]                  @relation("UserSmsLogs")
  pushSubscriptions   PushSubscription[]        @relation("UserPushSubscriptions")
  auditLogs           AuditLog[]                @relation("UserAuditLogs")
  savedSearches       SavedSearch[]
  jobAlerts           JobAlert[]
  apiRequestLogs      ApiRequestLog[] @relation("UserApiRequestLogs")
  errorLogs           ErrorLog[]      @relation("UserErrorLogs")
  billingPlans        BillingPlan[]
  billingAdjustments  BillingAdjustment[]
  featureOwnership    CompanyFeatureOwnership[] @relation("UserFeatureOwnership")
  lockedThreads       ChatRoom[]                @relation("LockedThreads") // Threadovi koje je korisnik zaključao
  addonSubscriptions  AddonSubscription[] // Add-on paketi korisnika

  // Testing runs authored by this user (admin)
  testRuns TestRun[] @relation("TestRunAuthor")

  // Composite unique constraint: email + role must be unique
  // This allows same email for different roles (e.g., USER and PROVIDER)
  // but prevents duplicate email within same role
  @@unique([email, role])
}

model ProviderProfile {
  id          String     @id @default(cuid())
  user        User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String     @unique
  bio         String?
  categories  Category[] @relation("ProviderCategories")
  portfolio   Json? // Portfolio slike i radovi
  ratingAvg   Float      @default(0)
  ratingCount Int        @default(0)

  // REPUTATION SYSTEM - Response time & conversion tracking
  avgResponseTimeMinutes   Float @default(0) // Prosječno vrijeme odgovora u minutama
  totalResponseTimeTracked Int   @default(0) // Broj trackanih odgovora (za izračun prosjeka)
  conversionRate           Float @default(0) // Stopa konverzije leadova (iz ProviderROI, cached za brzi pristup)

  serviceArea   String?
  specialties   String[] // Specijalizacije pružatelja
  experience    Int? // Godine iskustva
  website       String? // Website pružatelja
  isAvailable   Boolean      @default(true) // Dostupnost za nove poslove
  legalStatus   LegalStatus? @relation(fields: [legalStatusId], references: [id])
  legalStatusId String? // Pravni status (obrt, d.o.o., itd.)
  taxId         String? // OIB (porezni broj)
  companyName   String? // Naziv obrta/firme

  // USLUGAR EXCLUSIVE - Licence i limiti kategorija
  maxCategories Int               @default(5) // Max broj kategorija koje smije odabrati
  licenses      ProviderLicense[] // Licence koje posjeduje
  nkdCodes      String[] // NKD kodovi koje firma pokriva

  // Featured Profile - PRO users only
  isFeatured Boolean @default(false) // Featured badge za PRO korisnike

  // Approval status za licence (odobrenje admina)
  approvalStatus ProviderApprovalStatus? @default(WAITING_FOR_APPROVAL) // Status odobrenja

  // KYC VERIFICATION - KYC-lite verifikacija za freelancere/samostalne djelatnike
  kycVerified          Boolean   @default(false) // Verificiran status
  kycDocumentUrl       String? // URL Rješenja Porezne uprave
  kycExtractedOib      String? // OIB extrahiran iz dokumenta
  kycExtractedName     String? // Ime extrahirano iz dokumenta
  kycDocumentType      String? // Tip dokumenta (RPO_SOLUTION, OBRT_REGISTRY, etc.)
  kycPublicConsent     Boolean   @default(false) // Izjava korisnika za javni prikaz podataka
  kycVerificationNotes String? // Admin bilješke
  kycVerifiedAt        DateTime? // Datum verifikacije
  kycOcrVerified       Boolean   @default(false) // OCR verifikacija prošla
  kycOibValidated      Boolean   @default(false) // OIB algoritamski validiran
  kycObrtnRegChecked   Boolean   @default(false) // Provjeren Obrtnim registrom
  kycKamaraChecked     Boolean   @default(false) // Provjeren komorskim imenikom (odvjetnik/liječnik/arhitekt)
  kycViesChecked       Boolean   @default(false) // Provjeren VIES (PDV)

  // Badge System
  badgeData                   Json? // { BUSINESS: {verified, source, date}, IDENTITY: {...}, SAFETY: {...} }
  identityEmailVerified       Boolean   @default(false) // Email verificiran na domeni tvrtke
  identityEmailVerifiedAt     DateTime? // Datum email verifikacije
  identityEmailAddress        String? // Email adresa na domeni tvrtke za verifikaciju
  identityEmailToken          String?   @unique // Verifikacijski token za company email
  identityEmailTokenExpiresAt DateTime? // Istek verifikacijskog tokena za company email
  identityPhoneVerified       Boolean   @default(false) // Telefonski broj verificiran
  identityPhoneVerifiedAt     DateTime? // Datum telefonske verifikacije
  identityDnsVerified         Boolean   @default(false) // DNS TXT verifikacija
  identityDnsVerifiedAt       DateTime? // Datum DNS verifikacije
  safetyInsuranceUrl          String? // URL police osiguranja
  safetyInsuranceUploadedAt   DateTime? // Datum upload-a police osiguranja

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // GEO-DYNAMIC LOCATIONS - Multiple team locations per provider
  teamLocations ProviderTeamLocation[]

  // DIRECTOR & TEAM MANAGEMENT
  isDirector  Boolean           @default(false) // Da li je direktor/administrator profila tvrtke
  companyId   String? // ID tvrtke (ako je član tima, povezuje se s direktorom)
  company     ProviderProfile?  @relation("CompanyMembers", fields: [companyId], references: [id], onDelete: SetNull)
  teamMembers ProviderProfile[] @relation("CompanyMembers") // Članovi tima (ako je direktor)

  // INTERNA DISTRIBUCIJA LEADOVA
  directorLeads   CompanyLeadQueue[] @relation("DirectorLeads") // Leadovi koje je direktor primio
  teamMemberLeads CompanyLeadQueue[] @relation("TeamMemberLeads") // Leadovi dodijeljeni tim članu
}

// Geo-dynamic team locations (mobilni timovi, više lokacija)
model ProviderTeamLocation {
  id         String          @id @default(cuid())
  provider   ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId String

  // Lokacija tima
  name       String // npr. "Tim A - Dalmacija", "Sjedište Zagreb"
  city       String // Grad
  latitude   Float? // GPS koordinata
  longitude  Float? // GPS koordinata
  address    String? // Puna adresa (opcionalno)
  postalCode String? // Poštanski broj

  // Geo-pokrivanje
  radiusKm  Int     @default(50) // Radijus pokrivanja u km (npr. 80 km)
  isActive  Boolean @default(true) // Privremeno aktivirati/deaktivirati
  isPrimary Boolean @default(false) // Glavna lokacija (administrativno sjedište)

  // Metapodaci
  notes        String? // Napomene (npr. "Tim je ovdje do kraja ožujka")
  lastActiveAt DateTime? // Kada je tim zadnji put aktivan bio na ovoj lokaciji

  // Statistika po regiji
  leadsReceived  Int @default(0)
  leadsAccepted  Int @default(0)
  leadsConverted Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId])
  @@index([isActive])
  @@index([isPrimary])
  @@index([city])
}

model Category {
  id                 String              @id @default(cuid())
  name               String              @unique
  description        String?
  parentId           String? // Za hijerarhijske kategorije
  parent             Category?           @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children           Category[]          @relation("CategoryHierarchy")
  providers          ProviderProfile[]   @relation("ProviderCategories")
  billingPlans       BillingPlan[]
  subscriptionPlans  SubscriptionPlan[] // Segmentni paketi po kategoriji
  addonSubscriptions AddonSubscription[] // Add-on paketi po kategoriji
  jobs               Job[]

  // USLUGAR EXCLUSIVE - NKD i licence
  nkdCode          String? // NKD kod djelatnosti (npr. "43.21" za električne instalacije)
  requiresLicense  Boolean @default(false) // Zahtijeva li djelatnost licencu
  licenseType      String? // Tip licence (npr. "Elektrotehnička licenca")
  licenseAuthority String? // Tijelo koje izdaje dozvolu (npr. "Hrvatska komora inženjera")
  icon             String? // Emoji ili URL ikone za kategoriju

  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
}

model Job {
  id           String    @id @default(cuid())
  title        String
  description  String
  projectType  String? // Vrsta projekta (npr. "Renovacija", "Gradnja", "Popravak")
  customFields Json? // Dinamička polja ovisno o kategoriji i vrsti projekta
  budgetMin    Int?
  budgetMax    Int?
  city         String?
  latitude     Float? // Geolokacija posla
  longitude    Float? // Geolokacija posla
  status       JobStatus @default(OPEN)
  urgency      Urgency   @default(NORMAL) // Hitnost posla
  jobSize      JobSize? // Veličina posla
  deadline     DateTime? // Rok izvršenja
  images       String[] // Slike posla

  // USLUGAR EXCLUSIVE polja
  isExclusive        Boolean @default(true) // Ekskluzivan lead (samo 1 provider)
  leadPrice          Int?    @default(10) // Cijena u kreditima (10-20)
  assignedProvider   User?   @relation("AssignedJobs", fields: [assignedProviderId], references: [id], onDelete: SetNull)
  assignedProviderId String?
  leadStatus         String  @default("AVAILABLE") // Status ekskluzivnog leada (AVAILABLE, ASSIGNED, CONTACTED, CONVERTED, REFUNDED)
  clientVerified     Boolean @default(false) // Verificiran klijent
  qualityScore       Int?    @default(0) // AI score kvalitete (0-100)

  user                  User?               @relation("UserJobs", fields: [userId], references: [id], onDelete: Cascade)
  userId                String? // Nullable za anonimne korisnike
  linkingToken          String? // Token za povezivanje posla s računom nakon registracije
  linkingTokenExpiresAt DateTime? // Istek linking tokena (7 dana)
  category              Category            @relation(fields: [categoryId], references: [id])
  categoryId            String
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  offers                Offer[]
  acceptedOfferId       String?
  chatRooms             ChatRoom[]          @relation("jobChatRooms")
  leadPurchases         LeadPurchase[]
  creditTransactions    CreditTransaction[] @relation("JobTransactions")
  leadQueue             LeadQueue[]         @relation("JobQueue")
  companyLeadQueue      CompanyLeadQueue[]  @relation("CompanyJobQueue")
  notifications         Notification[]
  reviews               Review[] // Recenzije ostavljene na ovom job-u
  auditLogs             AuditLog[]          @relation("JobAuditLogs") // Audit logovi za otkrivanje kontakata
  chatbotSessions       ChatbotSession[]    @relation("ChatbotJob")

  // MODERATION
  moderationStatus          ModerationStatus @default(PENDING) // Status moderacije
  moderationReviewedBy      String? // ID admina koji je pregledao
  moderationReviewedAt      DateTime? // Kada je pregledano
  moderationRejectionReason String? // Razlog odbijanja (ako je odbijen)
  moderationNotes           String? // Bilješke moderatora
}

model Offer {
  id            String         @id @default(cuid())
  amount        Int
  message       String?
  status        OfferStatus    @default(PENDING)
  isNegotiable  Boolean        @default(true) // Može li se pregovarati o cijeni
  estimatedDays Int? // Procijenjeni broj dana za izvršenje
  job           Job            @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId         String
  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  notifications Notification[]

  // MODERATION
  moderationStatus          ModerationStatus @default(PENDING) // Status moderacije
  moderationReviewedBy      String? // ID admina koji je pregledao
  moderationReviewedAt      DateTime? // Kada je pregledano
  moderationRejectionReason String? // Razlog odbijanja (ako je odbijen)
  moderationNotes           String? // Bilješke moderatora

  @@index([moderationStatus])
}

model Review {
  id         String   @id @default(cuid())
  rating     Int
  comment    String?
  job        Job      @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId      String // Job na kojem su radili zajedno
  from       User     @relation("reviewsGiven", fields: [fromUserId], references: [id], onDelete: Cascade)
  fromUserId String
  to         User     @relation("reviewsReceived", fields: [toUserId], references: [id], onDelete: Cascade)
  toUserId   String
  createdAt  DateTime @default(now())

  // RECIPROCAL DELAY - Simultana objava ocjena
  isPublished    Boolean   @default(false) // Da li je review objavljen (vidljiv javno)
  publishedAt    DateTime? // Kada je review objavljen
  reviewDeadline DateTime? // Rok za ocjenjivanje (7-10 dana od završetka posla)

  // REPLY - Odgovor na recenziju (1x dozvoljen)
  replyText  String? // Tekst odgovora na recenziju
  repliedAt  DateTime? // Kada je odgovor poslan
  hasReplied Boolean   @default(false) // Da li je već odgovoreno (sprječava višestruke odgovore)

  // MODERATION
  moderationStatus          ModerationStatus @default(PENDING) // Status moderacije
  moderationReviewedBy      String? // ID admina koji je pregledao
  moderationReviewedAt      DateTime? // Kada je pregledano
  moderationRejectionReason String? // Razlog odbijanja (ako je odbijen)
  moderationNotes           String? // Bilješke moderatora

  // REPORT - Prijava lažnih ocjena
  isReported        Boolean       @default(false) // Da li je recenzija prijavljena kao lažna
  reportedBy        String? // ID korisnika koji je prijavio
  reportedAt        DateTime? // Kada je prijavljeno
  reportReason      String? // Razlog prijave (npr. "Lažna ocjena", "Neprikladan sadržaj", "Osveta")
  reportStatus      ReportStatus? // Status prijave (PENDING, REVIEWED, DISMISSED, ACCEPTED)
  reportReviewedBy  String? // ID admina koji je pregledao prijavu
  reportReviewedAt  DateTime? // Kada je prijava pregledana
  reportReviewNotes String? // Bilješke admina o prijavi

  @@unique([jobId, fromUserId]) // Jedna recenzija po job-u od svake strane
  @@index([jobId])
  @@index([toUserId])
  @@index([moderationStatus])
  @@index([isPublished])
  @@index([reviewDeadline])
  @@index([isReported])
  @@index([reportStatus])
}

enum Role {
  USER
  PROVIDER
  ADMIN
}

enum JobStatus {
  OPEN
  IN_PROGRESS
  COMPLETED
  CANCELLED
}

enum OfferStatus {
  PENDING
  ACCEPTED
  REJECTED
}

enum NotificationType {
  NEW_JOB
  NEW_OFFER
  OFFER_ACCEPTED
  OFFER_REJECTED
  JOB_COMPLETED
  REVIEW_RECEIVED
  SYSTEM
  JOB_CANCELLED
  OFFER_NOTIFICATION
}

enum Urgency {
  LOW
  NORMAL
  HIGH
  URGENT
}

enum JobSize {
  SMALL
  MEDIUM
  LARGE
  EXTRA_LARGE
}

// Novi modeli za trebam.hr funkcionalnosti

model Notification {
  id        String           @id @default(cuid())
  title     String
  message   String
  type      NotificationType
  isRead    Boolean          @default(false)
  user      User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    String
  jobId     String? // Povezano s poslom
  offerId   String? // Povezano s ponudom
  job       Job?             @relation(fields: [jobId], references: [id], onDelete: Cascade)
  offer     Offer?           @relation(fields: [offerId], references: [id], onDelete: Cascade)
  createdAt DateTime         @default(now())
}

model ChatRoom {
  id           String        @id @default(cuid())
  name         String?
  job          Job?          @relation("jobChatRooms", fields: [jobId], references: [id], onDelete: Cascade)
  jobId        String?
  participants User[]        @relation("participants")
  messages     ChatMessage[]
  auditLogs    AuditLog[] // Audit logovi za ovaj room
  slaTrackings MessageSLA[] // SLA tracking za poruke u ovom roomu

  // THREAD LOCKING
  isLocked       Boolean   @default(false) // Da li je thread zaključan (read-only)
  lockedAt       DateTime? // Kada je thread zaključan
  lockedReason   String? // Razlog zaključavanja (JOB_COMPLETED, INACTIVITY, MANUAL)
  unlockedUntil  DateTime? // Privremeno otključan do (null = trajno zaključan)
  lastActivityAt DateTime? // Zadnja aktivnost u threadu (za automatsko zaključavanje)
  lockedBy       User?     @relation("LockedThreads", fields: [lockedById], references: [id], onDelete: SetNull)
  lockedById     String? // ID korisnika koji je zaključao thread (null = automatski)

  // CHAT-BOT
  isBotRoom Boolean @default(false) // Da li je ovo chat-bot soba

  // SUPPORT CHAT
  isSupportRoom Boolean @default(false) // Da li je ovo support chat soba (VIP podrška 24/7)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isLocked])
  @@index([lastActivityAt])
}

model ChatMessage {
  id          String        @id @default(cuid())
  content     String // Tekst poruke (može biti prazan ako su samo slike)
  attachments String[]      @default([]) // URL-ovi priloženih slika
  status      MessageStatus @default(SENT) // SENT, DELIVERED, READ
  readAt      DateTime? // Datum i vrijeme kada je poruka pročitana
  sender      User          @relation("senderMessages", fields: [senderId], references: [id], onDelete: Cascade)
  senderId    String
  room        ChatRoom      @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId      String
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt // Ažurirano kada se poruka uredi

  // VERSIONING
  versions    MessageVersion[] // Povijest verzija poruke
  isEdited    Boolean          @default(false) // Da li je poruka ikad uređena
  editedAt    DateTime? // Kada je poruka zadnji put uređena
  auditLogs   AuditLog[] // Audit logovi za ovu poruku
  slaTracking MessageSLA? // SLA tracking za ovu poruku

  // MODERATION (samo za poruke koje su prijavljene)
  moderationStatus          ModerationStatus? // Status moderacije (null = nije prijavljeno)
  moderationReportedBy      String? // ID korisnika koji je prijavio
  moderationReportedAt      DateTime? // Kada je prijavljeno
  moderationReviewedBy      String? // ID admina koji je pregledao
  moderationReviewedAt      DateTime? // Kada je pregledano
  moderationRejectionReason String? // Razlog odbijanja (ako je odbijen)
  moderationNotes           String? // Bilješke moderatora

  // CHAT-BOT
  isBotMessage Boolean @default(false) // Da li je ovo bot poruka
  botAction    String? // Akcija bot poruke (SHOW_CONTACT_INFO, OPEN_CHAT, itd.)

  @@index([roomId, createdAt])
  @@index([status])
  @@index([moderationStatus])
  @@index([isEdited])
  @@index([isBotMessage])
}

model MessageVersion {
  id          String      @id @default(cuid())
  message     ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId   String
  content     String // Sadržaj verzije
  attachments String[]    @default([]) // Privici verzije
  version     Int // Broj verzije (1, 2, 3...)
  editedBy    User        @relation("messageVersions", fields: [editedById], references: [id], onDelete: Cascade)
  editedById  String // ID korisnika koji je uredio poruku
  editedAt    DateTime    @default(now()) // Kada je verzija kreirana
  reason      String? // Razlog uređivanja (opcionalno)

  @@index([messageId, version])
  @@index([editedAt])
}

// Audit Log za sve akcije vezane uz poruke
model AuditLog {
  id        String          @id @default(cuid())
  action    AuditActionType // Tip akcije
  actor     User            @relation("UserAuditLogs", fields: [actorId], references: [id], onDelete: Cascade)
  actorId   String // ID korisnika koji je izvršio akciju
  message   ChatMessage?    @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId String? // ID poruke (ako je akcija vezana uz poruku)
  room      ChatRoom?       @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId    String? // ID chat rooma (ako je akcija vezana uz room)
  job       Job?            @relation("JobAuditLogs", fields: [jobId], references: [id], onDelete: Cascade)
  jobId     String? // ID posla (za otkrivanje kontakata)
  metadata  Json? // Dodatni podaci (npr. stara/nova verzija, razlog, itd.)
  ipAddress String? // IP adresa korisnika
  userAgent String? // User agent korisnika
  createdAt DateTime        @default(now())

  @@index([actorId, createdAt])
  @@index([messageId, createdAt])
  @@index([roomId, createdAt])
  @@index([jobId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
}

// Pretplate (za provajdere usluga)
model Subscription {
  id                     String             @id @default(cuid())
  user                   User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId                 String             @unique
  plan                   String             @default("BASIC") // BASIC, PREMIUM, PRO
  status                 SubscriptionStatus @default(ACTIVE)
  credits                Int                @default(0) // Legacy - ukupno kredita
  creditsBalance         Int                @default(0) // Trenutno stanje kredita
  lifetimeCreditsUsed    Int                @default(0) // Ukupno potrošeno kredita (samo za statistiku)
  lifetimeLeadsConverted Int                @default(0) // Ukupno konvertiranih leadova
  expiresAt              DateTime?
  cancelledAt            DateTime?
  createdAt              DateTime           @default(now())
  updatedAt              DateTime           @updatedAt

  invoices        Invoice[]
  trialEngagement TrialEngagement?
  history         SubscriptionHistory[] // Povijest promjena pretplate

  @@index([userId])
  @@index([status])
}

// Engagement tracking tijekom TRIAL-a
model TrialEngagement {
  id             String       @id @default(cuid())
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId         String       @unique // Jedan engagement zapis po korisniku
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId String       @unique // Veza na TRIAL subscription

  // Engagement metrike
  leadsPurchased        Int       @default(0) // Broj kupljenih leadova tijekom TRIAL-a
  leadsConverted        Int       @default(0) // Broj konvertiranih leadova (uspešno završeni poslovi)
  offersSent            Int       @default(0) // Broj poslanih ponuda
  chatMessagesSent      Int       @default(0) // Broj poslanih chat poruka
  loginsCount           Int       @default(0) // Broj login-a tijekom TRIAL-a
  lastLoginAt           DateTime? // Zadnji login
  totalTimeSpentMinutes Int       @default(0) // Ukupno vrijeme provedeno na platformi (u minutama)
  lastActivityAt        DateTime? // Zadnja aktivnost

  // Metapodaci
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([subscriptionId])
  @@index([lastActivityAt])
}

// Povijest pretplata - praćenje svih promjena plana, nadogradnje i otkazivanja
model SubscriptionHistory {
  id             String       @id @default(cuid())
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  subscriptionId String
  user           User         @relation("UserSubscriptionHistory", fields: [userId], references: [id], onDelete: Cascade)
  userId         String // Za brže query-e bez join-a

  // Informacije o promjeni
  action         SubscriptionHistoryAction // CREATED, UPGRADED, DOWNGRADED, RENEWED, CANCELLED, EXPIRED, REACTIVATED
  previousPlan   String? // Prethodni plan (null ako je CREATED)
  newPlan        String // Novi plan
  previousStatus SubscriptionStatus? // Prethodni status
  newStatus      SubscriptionStatus // Novi status

  // Financijski podaci
  price          Float? // Cijena pretplate (EUR)
  proratedAmount Float? // Prorated iznos (za upgrade/downgrade)
  discountAmount Float? // Iznos popusta
  discountType   String? // Tip popusta (new_user, trial_upgrade, prorated, itd.)

  // Krediti
  creditsAdded  Int? // Broj dodanih kredita
  creditsBefore Int? // Stanje kredita prije promjene
  creditsAfter  Int? // Stanje kredita nakon promjene

  // Vremenski periodi
  validFrom         DateTime? // Početak valjanosti (za novu pretplatu)
  validUntil        DateTime? // Kraj valjanosti (za novu pretplatu)
  previousExpiresAt DateTime? // Prethodni expiresAt (za upgrade/downgrade)

  // Razlog i metapodaci
  reason   String? // Razlog promjene (npr. "User requested upgrade", "Automatic downgrade after expiration")
  notes    String? // Dodatne bilješke
  metadata Json? // Dodatni podaci (npr. Stripe payment intent ID, invoice ID, itd.)

  // Audit informacije
  changedBy String? // ID korisnika/admina koji je izvršio promjenu (null = automatski)
  ipAddress String? // IP adresa (ako je promjena izvršena preko API-ja)

  createdAt DateTime @default(now())

  @@index([subscriptionId, createdAt])
  @@index([userId, createdAt])
  @@index([action, createdAt])
  @@index([createdAt])
}

// Add-on paketi - proširenje osnovnog plana s regijama, kategorijama ili kreditima
// Lifecycle: ACTIVE → LOW_BALANCE → EXPIRED/DEPLETED → GRACE_MODE → RENEWED
model AddonSubscription {
  id     String @id @default(cuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String // ID direktora (direktor je vlasnik tvrtke)

  type        AddonType // REGION, CATEGORY, CREDITS
  scope       String // Vrijednost: regija (npr. "Zagreb"), categoryId, ili broj kredita
  displayName String // Ljudski čitljiv naziv (npr. "Dalmacija Add-on", "Građevina Add-on", "50 Extra Credits")

  // Za REGION i CATEGORY add-one
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId String? // Ako je type CATEGORY, ovo je categoryId

  // Za CREDITS add-one
  creditsAmount Int? // Broj kredita ako je type CREDITS

  // Status i lifecycle
  status    AddonStatus @default(ACTIVE)
  autoRenew Boolean     @default(false) // Automatska obnova nakon isteka

  // Vremenski periodi
  validFrom  DateTime  @default(now())
  validUntil DateTime // Datum isteka
  graceUntil DateTime? // Kraj grace perioda (7 dana nakon validUntil)

  // Cijena i naplata
  price    Float // Cijena u EUR
  currency String @default("EUR")

  // Stripe povezanost
  stripeSubscriptionId String? // Stripe Subscription ID za auto-renew
  stripePriceId        String? // Stripe Price ID

  // Metapodaci
  notes           String?
  cancelledAt     DateTime? // Kada je otkazan
  cancelledReason String? // Razlog otkazivanja

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relacije
  usage     AddonUsage?
  eventLogs AddonEventLog[]
  invoices  Invoice[]       @relation("AddonInvoices")

  @@unique([userId, type, scope]) // Jedan korisnik može imati jedan add-on po tipu i scope-u
  @@index([userId])
  @@index([type])
  @@index([status])
  @@index([validUntil])
  @@index([categoryId])
}

// Praćenje potrošnje Add-on paketa
model AddonUsage {
  id      String            @id @default(cuid())
  addon   AddonSubscription @relation(fields: [addonId], references: [id], onDelete: Cascade)
  addonId String            @unique // Jedan usage zapis po add-onu

  // Za CREDITS add-one
  consumed       Int   @default(0) // Potrošeno kredita
  remaining      Int // Preostalo kredita
  percentageUsed Float @default(0.0) // Postotak potrošnje (0-100)

  // Za REGION i CATEGORY add-one (broj leadova)
  leadsReceived  Int @default(0) // Broj leadova primljenih kroz ovaj add-on
  leadsConverted Int @default(0) // Broj konvertiranih leadova

  // Notifikacije
  notifiedAt80     DateTime? // Kada je poslana notifikacija na 80%
  notifiedAt50     DateTime? // Kada je poslana notifikacija na 50%
  notifiedAt20     DateTime? // Kada je poslana notifikacija na 20%
  notifiedExpiring DateTime? // Kada je poslana notifikacija o isteku (3 dana prije)

  lastUpdated DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([addonId])
  @@index([percentageUsed])
}

// Event log za Add-on pakete (povijest promjena statusa)
model AddonEventLog {
  id      String            @id @default(cuid())
  addon   AddonSubscription @relation(fields: [addonId], references: [id], onDelete: Cascade)
  addonId String

  eventType String // "PURCHASED", "RENEWED", "EXPIRED", "DEPLETED", "LOW_BALANCE", "GRACE_STARTED", "CANCELLED"
  oldStatus AddonStatus? // Prethodni status
  newStatus AddonStatus? // Novi status
  metadata  Json? // Dodatni podaci (npr. consumed, remaining, reason)

  occurredAt DateTime @default(now())

  @@index([addonId])
  @@index([eventType])
  @@index([occurredAt])
}

// Subscription Plans - Cjenik planova (za admin upravljanje)
// Segmentni model paketa - omogućava definiranje različitih paketa prema regijama ili kategorijama
model SubscriptionPlan {
  id           String   @id @default(cuid())
  name         String // BASIC, PREMIUM, PRO
  displayName  String // "Basic", "Premium", "Pro"
  price        Float // Cijena u EUR
  currency     String   @default("EUR")
  credits      Int // Broj kredita
  features     String[] // Array feature opisa
  isPopular    Boolean  @default(false) // Badge "Najpopularniji"
  displayOrder Int      @default(0) // Redoslijed prikaza
  isActive     Boolean  @default(true) // Da li je plan aktivan
  description  String? // Opis plana
  savings      String? // Tekst uštede (npr. "Ušteda 161€ vs pay-per-lead")

  // SEGMENTNI MODEL PAKETA - Segmentacija po regiji/kategoriji
  category   Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId String? // Kategorija za koju je paket specifičan (null = sve kategorije)
  region     String? // Regija/grad za koju je paket specifičan (npr. "Zagreb", "Dalmacija", "Istra") - null = sve regije

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, categoryId, region]) // Jedinstvena kombinacija name + category + region
  @@index([isActive])
  @@index([displayOrder])
  @@index([categoryId])
  @@index([region])
  @@index([categoryId, region]) // Kompozitni indeks za brže pretraživanje segmentiranih paketa
}

// Fakture za plaćanja
model Invoice {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  invoiceNumber String        @unique // Format: YYYY-XXXX (npr. 2025-0001) - resetira se na 1 svake godine
  type          InvoiceType
  status        InvoiceStatus @default(DRAFT) // DRAFT, SENT, PAID, CANCELLED, STORNED
  amount        Int // Iznos u centima (EUR)
  currency      String        @default("EUR")
  taxAmount     Int           @default(0) // PDV u centima
  totalAmount   Int // Ukupno (amount + taxAmount)

  // Povezano sa transakcijama
  subscription   Subscription?      @relation(fields: [subscriptionId], references: [id], onDelete: SetNull)
  subscriptionId String?
  leadPurchase   LeadPurchase?      @relation(fields: [leadPurchaseId], references: [id], onDelete: SetNull)
  leadPurchaseId String?
  addon          AddonSubscription? @relation("AddonInvoices", fields: [addonId], references: [id], onDelete: SetNull)
  addonId        String?

  // Stripe povezanost
  stripePaymentIntentId String? // Za subscription payment
  stripeInvoiceId       String? // Stripe invoice ID (ako postoji)

  // Podaci fakture
  issueDate DateTime  @default(now())
  dueDate   DateTime?
  paidAt    DateTime?

  // PDF faktura
  pdfUrl         String? // URL za preuzimanje PDF-a (S3 ili storage)
  pdfGeneratedAt DateTime?

  // Email
  emailSentAt DateTime?
  emailSentTo String? // Email adresa na koju je poslano

  // HR Fiskalizacija - ZKI i JIR
  zkiCode             String? // Zaštitni Kod Izdavatelja (ZKI) - generira se lokalno
  jirCode             String? // Jedinstveni Identifikacijski Registar (JIR) - dobiva se iz Porezne
  fiscalizedAt        DateTime? // Datum kada je faktura fiskalizirana
  fiscalizationStatus String? // PENDING, SUCCESS, FAILED, NOT_REQUIRED
  fiscalizationError  String? // Greška ako fiskalizacija ne uspije
  qrCodeUrl           String? // URL QR koda s ZKI i JIR podacima

  // Metapodaci
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([invoiceNumber])
  @@index([type])
  @@index([status])
  @@index([issueDate])
}

// Kupljeni ekskluzivni leadovi (1 lead = 1 provider)
model LeadPurchase {
  id                    String               @id @default(cuid())
  job                   Job                  @relation(fields: [jobId], references: [id], onDelete: Cascade)
  jobId                 String
  provider              User                 @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId            String
  creditsSpent          Int // Broj kredita potrošenih za kupovinu
  leadPrice             Int // Cijena leada u trenutku kupnje
  status                LeadPurchaseStatus   @default(ACTIVE)
  contactUnlocked       Boolean              @default(false) // Pay-per-contact: je li kontakt otključan
  contactUnlockedAt     DateTime? // Kada je kontakt otključan
  contactedAt           DateTime? // Kada je provider kontaktirao klijenta
  convertedAt           DateTime? // Kada je lead konvertiran u posao
  refundedAt            DateTime? // Kada je izvršena refundacija
  refundReason          String? // Razlog refundacije
  refundRequestStatus   RefundRequestStatus? // Status refund zahtjeva (PENDING, APPROVED, REJECTED)
  refundRequestedAt     DateTime? // Kada je zatražen refund
  refundApprovedBy      String? // ID admina koji je odobrio refund
  refundApprovedAt      DateTime? // Kada je refund odobren
  refundRejectedReason  String? // Razlog odbijanja refund-a (ako je odbijen)
  stripePaymentIntentId String? // Stripe Payment Intent ID (za refund kroz Stripe)
  stripeRefundId        String? // Stripe Refund ID (nakon refund-a)
  notes                 String? // Dodatne bilješke
  createdAt             DateTime             @default(now())
  updatedAt             DateTime             @updatedAt

  creditTransactions CreditTransaction[]
  invoices           Invoice[]

  @@index([jobId])
  @@index([providerId])
  @@index([status])
  @@index([refundRequestStatus])
  @@index([createdAt])
}

// Dinamički billing po volumenu leadova - planovi i korekcije

/// Billing plan definiran po korisniku, kategoriji i/ili regiji, s očekivanim volumenom leadova po periodu
model BillingPlan {
  id            String        @id @default(cuid())
  user          User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId        String
  name          String // Npr. "Građevina Zagreb - Basic"
  category      Category?     @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  categoryId    String?
  region        String? // Npr. grad ili regija (Zagreb, Dalmacija...)
  expectedLeads Int // Očekivani broj leadova po periodu
  period        BillingPeriod @default(MONTHLY) // Obračunski period
  isActive      Boolean       @default(true)
  isPaused      Boolean       @default(false) // Ako je true, plan je pauziran i ne naplaćuje se

  // Garancija minimalnog broja leadova
  guaranteeEnabled   Boolean @default(false) // Je li uključen guarantee za ovaj plan
  guaranteedMinLeads Int? // Ako je null, koristi expectedLeads kao garantirani minimum

  // Carryover neiskorištenih leadova
  carryoverEnabled Boolean @default(false) // Je li uključen carryover za ovaj plan
  carryoverLeads   Int     @default(0) // Neiskorišteni leadovi preneseni u sljedeći period

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  adjustments BillingAdjustment[]

  @@index([userId])
  @@index([categoryId])
  @@index([region])
  @@index([isActive])
}

/// Korekcija billing-a na temelju usporedbe očekivanog i isporučenog volumena leadova
model BillingAdjustment {
  id                String                  @id @default(cuid())
  billingPlan       BillingPlan             @relation(fields: [billingPlanId], references: [id], onDelete: Cascade)
  billingPlanId     String
  user              User                    @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  periodStart       DateTime
  periodEnd         DateTime
  expectedLeads     Int
  deliveredLeads    Int
  realValueFactor   Float? // deliveredLeads / expectedLeads (proporcionalna naplata REAL_VALUE)
  adjustmentType    BillingAdjustmentType
  adjustmentCredits Int // Pozitivno: broj kredita za korekciju (bilo da su kredit ili surcharge)
  status            BillingAdjustmentStatus @default(PENDING)
  notes             String?
  createdAt         DateTime                @default(now())
  appliedAt         DateTime?

  @@index([userId])
  @@index([billingPlanId])
  @@index([periodStart, periodEnd])
  @@index([status])
}

// Feature Ownership System - Automatska provjera postojećih funkcionalnosti
model FeatureCatalog {
  id          String   @id @default(cuid())
  featureKey  String   @unique // Npr. "CRM", "CHAT", "STATISTICS", "REGION_ZAGREB", "CATEGORY_GRADEVINA"
  name        String // Ljudski čitljiv naziv
  description String?
  category    String? // Npr. "MODULE", "REGION", "CATEGORY", "CREDITS"
  price       Float? // Cijena funkcionalnosti (opcionalno, ako se naplaćuje odvojeno)
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerships CompanyFeatureOwnership[]

  @@index([featureKey])
  @@index([category])
  @@index([isActive])
}

model CompanyFeatureOwnership {
  id         String         @id @default(cuid())
  user       User           @relation("UserFeatureOwnership", fields: [userId], references: [id], onDelete: Cascade)
  userId     String // ID direktora (direktor je vlasnik tvrtke)
  feature    FeatureCatalog @relation(fields: [featureKey], references: [featureKey], onDelete: Cascade)
  featureKey String
  grantedAt  DateTime       @default(now())
  grantedBy  String? // ID admina koji je dodijelio (null = automatski kroz paket)
  source     String? // Npr. "PREMIUM_PLAN", "ADDON_REGION", "MANUAL_GRANT"
  notes      String?

  history FeatureOwnershipHistory[]

  @@unique([userId, featureKey]) // Jedna tvrtka može imati jednu funkcionalnost samo jednom
  @@index([userId])
  @@index([featureKey])
  @@index([grantedAt])
}

model FeatureOwnershipHistory {
  id          String                  @id @default(cuid())
  ownership   CompanyFeatureOwnership @relation(fields: [ownershipId], references: [id], onDelete: Cascade)
  ownershipId String
  action      String // "GRANTED", "REVOKED", "RENEWED"
  occurredAt  DateTime                @default(now())
  actor       String? // ID korisnika/admina koji je izvršio akciju
  reason      String? // Razlog promjene
  metadata    Json? // Dodatni podaci (npr. planCode, addonId)

  @@index([ownershipId])
  @@index([occurredAt])
}

enum BillingPeriod {
  MONTHLY
  QUARTERLY
}

enum BillingAdjustmentType {
  CREDIT // Klijentu se odobravaju dodatni krediti / popust
  SURCHARGE // Dodatna naplata zbog većeg volumena od očekivanog
  NONE // Bez korekcije (zapis za transparentnost)
}

enum BillingAdjustmentStatus {
  PENDING
  APPLIED
  CANCELLED
}

// ROI statistika za providere
model ProviderROI {
  id                  String   @id @default(cuid())
  provider            User     @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId          String   @unique
  totalLeadsPurchased Int      @default(0)
  totalLeadsContacted Int      @default(0)
  totalLeadsConverted Int      @default(0)
  totalCreditsSpent   Int      @default(0)
  totalRevenue        Int      @default(0) // Ukupan prihod od leadova (EUR)
  conversionRate      Float    @default(0.0) // Postotak konverzije
  roi                 Float    @default(0.0) // Return on Investment
  avgLeadValue        Float    @default(0.0) // Prosječna vrijednost leada
  lastUpdated         DateTime @default(now())
  createdAt           DateTime @default(now())
}

// Transakcije kredita (history)
model CreditTransaction {
  id                String                @id @default(cuid())
  user              User                  @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId            String
  type              CreditTransactionType
  amount            Int // Pozitivan za dodavanje, negativan za trošenje
  balance           Int // Stanje nakon transakcije
  description       String?
  relatedJob        Job?                  @relation("JobTransactions", fields: [relatedJobId], references: [id], onDelete: SetNull)
  relatedJobId      String?
  relatedPurchase   LeadPurchase?         @relation(fields: [relatedPurchaseId], references: [id], onDelete: SetNull)
  relatedPurchaseId String?
  createdAt         DateTime              @default(now())

  @@index([userId])
  @@index([type])
  @@index([createdAt])
}

// Verifikacija klijenata (za kvalitetne leadove)
model ClientVerification {
  id              String    @id @default(cuid())
  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          String    @unique
  phoneVerified   Boolean   @default(false)
  emailVerified   Boolean   @default(false)
  idVerified      Boolean   @default(false) // Osobna iskaznica
  companyVerified Boolean   @default(false) // Potvrda firme (OIB, sudski registar)
  trustScore      Int       @default(0) // Score povjerenja (0-100)
  verifiedAt      DateTime?
  notes           String?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
}

// Licence pružatelja (za licencirane djelatnosti)
model ProviderLicense {
  id               String          @id @default(cuid())
  provider         ProviderProfile @relation(fields: [providerId], references: [id], onDelete: Cascade)
  providerId       String
  licenseType      String // Tip licence (npr. "Elektrotehnička licenca")
  licenseNumber    String // Broj dozvole
  issuingAuthority String // Tijelo koje je izdalo
  issuedAt         DateTime // Datum izdavanja
  expiresAt        DateTime? // Datum isteka (ako vrijedi)
  documentUrl      String? // URL skeniranog dokumenta
  isVerified       Boolean         @default(false) // Verificirana od strane admina
  verifiedAt       DateTime?
  verifiedBy       String? // Admin koji je verificirao
  notes            String?
  createdAt        DateTime        @default(now())
  updatedAt        DateTime        @updatedAt

  @@index([providerId])
  @@index([isVerified])
}

// USLUGAR EXCLUSIVE - Queue model za distribuciju leadova
// Umjesto broadcastinga na 6+ providera, leadovi idu u queue
model LeadQueue {
  id          String          @id @default(cuid())
  job         Job             @relation("JobQueue", fields: [jobId], references: [id], onDelete: Cascade)
  jobId       String
  providerId  String // Provider u queueu
  position    Int // Pozicija u queueu (1, 2, 3...)
  status      LeadQueueStatus @default(WAITING)
  offeredAt   DateTime? // Kada je lead ponuđen provideru
  respondedAt DateTime? // Kada je provider odgovorio
  expiresAt   DateTime? // Rok za odgovor (npr. 24h)
  response    QueueResponse? // Odgovor providera
  notes       String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  @@unique([jobId, providerId]) // Provider može biti samo jednom u queue za job
  @@index([jobId, position])
  @@index([providerId, status])
  @@index([status])
}

// Interni queue leadova unutar tvrtke (direktor → tim članovi)
model CompanyLeadQueue {
  id             String                     @id @default(cuid())
  job            Job                        @relation("CompanyJobQueue", fields: [jobId], references: [id], onDelete: Cascade)
  jobId          String
  director       ProviderProfile            @relation("DirectorLeads", fields: [directorId], references: [id], onDelete: Cascade)
  directorId     String // Direktor tvrtke koji je primio lead
  assignedTo     ProviderProfile?           @relation("TeamMemberLeads", fields: [assignedToId], references: [id], onDelete: SetNull)
  assignedToId   String? // Tim član kojem je dodijeljen (null = čeka dodjelu)
  position       Int // Pozicija u internom queueu (1, 2, 3...)
  status         CompanyLeadQueueStatus     @default(PENDING) // PENDING, ASSIGNED, IN_PROGRESS, COMPLETED, DECLINED
  assignmentType CompanyLeadAssignmentType? // MANUAL, AUTO
  assignedAt     DateTime? // Kada je dodijeljen
  startedAt      DateTime? // Kada je tim član počeo raditi
  completedAt    DateTime? // Kada je završen
  notes          String? // Bilješke direktora
  createdAt      DateTime                   @default(now())
  updatedAt      DateTime                   @updatedAt

  @@unique([jobId, directorId]) // Jedan lead može biti samo jednom u queue tvrtke
  @@index([directorId, status])
  @@index([assignedToId, status])
  @@index([status])
  @@index([jobId])
}

enum CompanyLeadQueueStatus {
  PENDING // Čeka dodjelu
  ASSIGNED // Dodijeljen tim članu
  IN_PROGRESS // Tim član radi na leadu
  COMPLETED // Završen
  DECLINED // Direktor odbio lead
}

enum CompanyLeadAssignmentType {
  MANUAL // Ručna dodjela od strane direktora
  AUTO // Automatska dodjela od strane enginea
}

// Pravni statusi pružatelja usluga
model LegalStatus {
  id          String   @id @default(cuid())
  code        String   @unique // INDIVIDUAL, SOLE_TRADER, COMPANY, etc.
  name        String // Naziv na hrvatskom
  description String? // Detaljan opis
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())

  users     User[]            @relation("UserLegalStatus")
  providers ProviderProfile[]
}

// ============================================================
// USLUGAR EXCLUSIVE - Enumovi
// ============================================================

// LeadStatus je String (AVAILABLE, ASSIGNED, CONTACTED, CONVERTED, REFUNDED, EXPIRED)

enum LeadPurchaseStatus {
  ACTIVE // Aktivan lead
  CONTACTED // Kontaktiran
  CONVERTED // Uspješno realiziran
  REFUNDED // Vraćeni krediti
  EXPIRED // Istekao
  CANCELLED // Otkazan
}

enum RefundRequestStatus {
  PENDING // Zahtjev za refund čeka odobrenje
  APPROVED // Refund je odobren
  REJECTED // Refund je odbijen
}

enum CreditTransactionType {
  PURCHASE // Kupovina kredita
  LEAD_PURCHASE // Trošenje kredita za lead
  REFUND // Povrat kredita
  BONUS // Bonus krediti
  SUBSCRIPTION // Krediti iz pretplate
  ADMIN_ADJUST // Admin prilagodba
}

// USLUGAR EXCLUSIVE - Queue statusi i odgovori
enum LeadQueueStatus {
  WAITING // Čeka svoj red
  OFFERED // Ponuđen provideru (trenutni u redu)
  ACCEPTED // Provider prihvatio
  DECLINED // Provider odbio
  EXPIRED // Isteklo vrijeme za odgovor
  SKIPPED // Preskočen (išli na sljedećeg)
}

enum QueueResponse {
  INTERESTED // Zainteresiran za lead
  NOT_INTERESTED // Nije zainteresiran
  NO_RESPONSE // Nije odgovorio
}

enum SubscriptionStatus {
  ACTIVE // Aktivna pretplata
  CANCELLED // Otkazana
  EXPIRED // Istekla
}

enum SubscriptionHistoryAction {
  CREATED // Nova pretplata kreirana
  UPGRADED // Nadogradnja na viši plan
  DOWNGRADED // Smanjenje na niži plan
  RENEWED // Obnova postojeće pretplate
  CANCELLED // Otkazivanje pretplate
  EXPIRED // Automatski istek pretplate
  REACTIVATED // Ponovna aktivacija otkazane pretplate
  PRORATED // Prorated billing (upgrade/downgrade)
}

// Add-on paketi - proširenje osnovnog plana
enum AddonType {
  REGION // Add-on za dodatnu regiju
  CATEGORY // Add-on za dodatnu kategoriju
  CREDITS // Add-on za dodatne kredite
}

enum AddonStatus {
  ACTIVE // Aktivni add-on
  LOW_BALANCE // Niska potrošnja (<20% preostalo)
  EXPIRED // Istekao (vrijeme)
  DEPLETED // Potrošen (krediti)
  GRACE_MODE // Grace period (7 dana nakon isteka)
  CANCELLED // Otkazan od strane korisnika
}

enum InvoiceType {
  SUBSCRIPTION // Faktura za pretplatu
  LEAD_PURCHASE // Faktura za kupovinu leada
  ADDON // Faktura za add-on paket
}

enum InvoiceStatus {
  DRAFT // Nacrt (još nije poslana)
  SENT // Poslana korisniku
  PAID // Plaćena
  CANCELLED // Otkazana
  STORNED // Stornirana (poništavajuća faktura je izdana)
}

enum MessageStatus {
  SENT // Poslana
  DELIVERED // Dostavljena (opcionalno - može se koristiti za push notifikacije)
  READ // Pročitana
}

enum ProviderApprovalStatus {
  WAITING_FOR_APPROVAL // Čeka odobrenje od admina
  APPROVED // Odobren (može koristiti TRIAL)
  REJECTED // Odbijen
  INACTIVE // Neaktivan
}

// ============================================================
// TESTING SYSTEM - Plans, Items, Runs
// ============================================================

enum TestRunStatus {
  DRAFT
  IN_PROGRESS
  COMPLETED
}

enum TestItemStatus {
  PENDING
  PASS
  FAIL
  BLOCKED
  NOT_APPLICABLE
}

model TestPlan {
  id          String   @id @default(cuid())
  name        String
  description String?
  category    String? // npr. "Korisnik", "Provider", "KYC"
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  items TestItem[]
  runs  TestRun[]  @relation("TestPlanRuns")

  @@index([name])
}

model TestItem {
  id             String   @id @default(cuid())
  plan           TestPlan @relation(fields: [planId], references: [id], onDelete: Cascade)
  planId         String
  title          String
  description    String?
  expectedResult String?
  dataVariations Json? // npr. { examples: ["ispravan OIB", "neispravan OIB"] }
  order          Int      @default(0)
  createdAt      DateTime @default(now())

  runItems TestRunItem[]

  @@index([planId])
  @@index([order])
}

model TestRun {
  id          String        @id @default(cuid())
  plan        TestPlan      @relation("TestPlanRuns", fields: [planId], references: [id], onDelete: Cascade)
  planId      String
  name        String
  createdBy   User?         @relation("TestRunAuthor", fields: [createdById], references: [id], onDelete: SetNull)
  createdById String?
  status      TestRunStatus @default(DRAFT)
  notes       String?
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  items TestRunItem[]

  @@index([planId])
  @@index([status])
}

model TestRunItem {
  id          String         @id @default(cuid())
  run         TestRun        @relation(fields: [runId], references: [id], onDelete: Cascade)
  runId       String
  item        TestItem       @relation(fields: [itemId], references: [id], onDelete: Cascade)
  itemId      String
  status      TestItemStatus @default(PENDING)
  comment     String?
  screenshots String[] // URL-ovi slika (upload API)
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@unique([runId, itemId])
  @@index([runId])
}

// Dokumentacija funkcionalnosti platforme
model DocumentationCategory {
  id        String   @id @default(cuid())
  name      String   @unique // "Registracija i Autentifikacija"
  order     Int      @default(0) // Redoslijed prikaza
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  features DocumentationFeature[]

  @@index([isActive])
  @@index([order])
}

model DocumentationFeature {
  id               String   @id @default(cuid())
  categoryId       String
  name             String // "Registracija korisnika usluge"
  summary          String? // Kratak opis
  details          String? // Detaljni opis (markdown)
  technicalDetails String? // Tehnički opis (frontend, backend, baza, API poziv) - samo admin
  implemented      Boolean  @default(true)
  deprecated       Boolean  @default(false)
  isAdminOnly      Boolean  @default(false) // Samo za admin dokumentaciju
  order            Int      @default(0) // Redoslijed unutar kategorije
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  category DocumentationCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([categoryId, name])
  @@index([categoryId])
  @@index([implemented])
  @@index([isAdminOnly])
  @@index([order])
}

// SMS Log - Pregled svih poslanih SMS-ova (admin)
model SmsLog {
  id        String   @id @default(cuid())
  phone     String // Broj telefona (format: +385XXXXXXXXX)
  message   String // Sadržaj poruke
  type      String // Tip poruke: VERIFICATION, LEAD_NOTIFICATION, REFUND, URGENT, OTHER
  status    String // Status: SUCCESS, FAILED, PENDING
  mode      String // Mode: twilio, simulation, twilio_error
  twilioSid String? // Twilio SID (ako je poslano preko Twilio)
  error     String? // Error poruka (ako je neuspješno)
  userId    String? // ID korisnika (ako je vezano za korisnika)
  metadata  Json? // Dodatni podaci (npr. leadId, jobId, itd.)
  createdAt DateTime @default(now())

  user User? @relation("UserSmsLogs", fields: [userId], references: [id], onDelete: SetNull)

  @@index([phone])
  @@index([status])
  @@index([type])
  @@index([userId])
  @@index([createdAt])
}

// Push Notification Subscription - Browser push notifications
model PushSubscription {
  id     String @id @default(cuid())
  user   User   @relation("UserPushSubscriptions", fields: [userId], references: [id], onDelete: Cascade)
  userId String

  // Web Push API subscription data
  endpoint String // Push service endpoint URL
  p256dh   String // User public key (base64)
  auth     String // Authentication secret (base64)

  // Metadata
  userAgent String? // Browser user agent
  isActive  Boolean @default(true) // Subscription aktivna

  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt
  lastUsedAt DateTime? // Kada je zadnji put korištena za slanje

  @@unique([userId, endpoint]) // Jedan korisnik može imati više uređaja
  @@index([userId])
  @@index([isActive])
  @@index([endpoint])
}

model MessageSLA {
  id                      String      @id @default(cuid())
  message                 ChatMessage @relation(fields: [messageId], references: [id], onDelete: Cascade)
  messageId               String      @unique // Jedan SLA tracking po poruci
  room                    ChatRoom    @relation(fields: [roomId], references: [id], onDelete: Cascade)
  roomId                  String
  expectedResponseMinutes Int         @default(240) // SLA: 4 sata (240 minuta) default
  respondedAt             DateTime? // Kada je odgovoreno (null = nije odgovoreno)
  responseTimeMinutes     Int? // Vrijeme odgovora u minutama (izračunato kada se odgovori)
  slaStatus               SLASStatus  @default(PENDING) // PENDING, MET, BREACHED
  breachedAt              DateTime? // Kada je SLA prekoračen
  reminderSentAt          DateTime? // Kada je poslana podsjetnica
  reminderCount           Int         @default(0) // Broj poslanih podsjetnica
  lastReminderAt          DateTime? // Kada je poslana zadnja podsjetnica

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([roomId, slaStatus])
  @@index([slaStatus, createdAt])
  @@index([reminderSentAt])
}

// Chat-bot Session - Vodi korisnika kroz prvi lead
model ChatbotSession {
  id              String    @id @default(cuid())
  provider        User      @relation("ChatbotSessions", fields: [providerId], references: [id], onDelete: Cascade)
  providerId      String
  job             Job?      @relation("ChatbotJob", fields: [jobId], references: [id], onDelete: SetNull)
  jobId           String?
  currentStep     Int       @default(1) // Trenutni korak u wizardu (1-5)
  status          String    @default("ACTIVE") // ACTIVE, COMPLETED, CANCELLED
  lastTrigger     String? // Zadnji trigger (LEAD_PURCHASED, CONTACT_CLIENT, itd.)
  lastTriggeredAt DateTime? // Kada je zadnji put triggeran
  startedAt       DateTime  @default(now())
  completedAt     DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([providerId, status])
  @@index([status])
}

// Spremljene pretrage - korisnici mogu spremiti svoje pretrage poslova
model SavedSearch {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  name        String // Naziv pretrage (npr. "Poslovi u Zagrebu")
  searchQuery String? // Tekst pretrage
  filters     Json // JSON sa filterima: { categoryId, city, budgetMin, budgetMax, etc. }
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastUsedAt  DateTime? // Kada je zadnji put korištena

  @@index([userId, isActive])
  @@index([userId, createdAt])
}

// Job Alerts - email notifikacije za nove poslove koji odgovaraju pretrazi
model JobAlert {
  id          String    @id @default(cuid())
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      String
  name        String // Naziv alerta (npr. "Novi poslovi u Zagrebu")
  searchQuery String? // Tekst pretrage
  filters     Json // JSON sa filterima: { categoryId, city, budgetMin, budgetMax, etc. }
  frequency   String    @default("DAILY") // DAILY, WEEKLY, INSTANT
  isActive    Boolean   @default(true)
  lastSentAt  DateTime? // Kada je zadnji put poslan email
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([userId, isActive])
  @@index([isActive, frequency])
  @@index([lastSentAt])
}

// API Request Logs - logiranje svih API zahtjeva za monitoring i debugging
model ApiRequestLog {
  id          String    @id @default(cuid())
  method      String // GET, POST, PUT, DELETE, PATCH
  path        String // API path (npr. /api/jobs)
  statusCode  Int // HTTP status kod
  userId      String? // ID korisnika (ako je autentificiran)
  user        User?    @relation("UserApiRequestLogs", fields: [userId], references: [id], onDelete: SetNull)
  ipAddress   String? // IP adresa klijenta
  userAgent   String? // User agent
  requestBody Json? // Request body (za POST/PUT/PATCH)
  responseTime Int // Vrijeme izvršavanja u ms
  errorMessage String? // Error poruka (ako ima)
  createdAt   DateTime  @default(now())

  @@index([method, path])
  @@index([statusCode])
  @@index([userId, createdAt])
  @@index([createdAt])
  @@index([path, createdAt])
}

// Error Logs - centralizirano logiranje grešaka
model ErrorLog {
  id          String    @id @default(cuid())
  level       String    @default("ERROR") // ERROR, WARN, CRITICAL
  message     String // Error poruka
  stack       String? // Stack trace
  endpoint    String? // API endpoint gdje se greška dogodila
  method      String? // HTTP metoda
  userId      String? // ID korisnika (ako je dostupan)
  user        User?    @relation("UserErrorLogs", fields: [userId], references: [id], onDelete: SetNull)
  ipAddress   String? // IP adresa
  userAgent   String? // User agent
  context     Json? // Dodatni kontekst (request body, query params, itd.)
  status      String    @default("NEW") // NEW, IN_PROGRESS, RESOLVED, IGNORED
  resolvedAt  DateTime? // Kada je greška riješena
  resolvedBy  String? // ID admin korisnika koji je riješio
  notes       String? // Admin napomene
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([level])
  @@index([status])
  @@index([userId, createdAt])
  @@index([endpoint, createdAt])
  @@index([createdAt])
}
